<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê≥®Èü≥Á¨¶ËôüÂ§ßÂÜíÈö™</title>
    <style>
        :root {
            --bg: #FDF6E3;
            --text: #555;
            --correct: #6BCB77;
            --wrong: #FF6B6B;
            --primary-color: #4A89A6;
            --btn-color: #FF7043; 
            --btn-shadow: #D84315;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "Microsoft JhengHei", "Rounded Mplus 1c", sans-serif;
            background-color: var(--bg);
            background-image: linear-gradient(180deg, #E0F7FA 0%, #FFF3E0 100%);
            background-attachment: fixed;
            color: var(--text);
            margin: 0;
            padding: 8px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden; 
            user-select: none;
            position: relative;
        }

        header {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 5px;
            flex-shrink: 0;
            height: 32px;
            gap: 8px;
        }

        h1 {
            color: #4A89A6;
            font-size: 1.3rem;
            text-shadow: 2px 2px 0px #fff;
            margin: 0;
            font-weight: 900;
            white-space: nowrap;
        }

        .header-icon {
            width: 28px;
            height: 28px;
            object-fit: contain;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.1));
        }

        .voice-control {
            position: absolute;
            right: 0;
            top: 0;
            font-size: 0.6rem;
            color: #666;
            background: rgba(255,255,255,0.6);
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 20;
        }

        .nav-container {
            background: rgba(0, 0, 0, 0.05); 
            padding: 3px;
            border-radius: 12px;
            margin-bottom: 5px;
            display: flex;
            width: 100%;
            max-width: 600px;
            flex-shrink: 0;
            height: 38px; 
        }

        .nav-btn {
            flex: 1;
            padding: 0;
            font-size: 0.95rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: transparent;
            color: #666; 
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .nav-icon-img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            vertical-align: middle;
        }

        .nav-btn.active {
            background-color: #fff;
            color: var(--primary-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
            flex: 1; 
            flex-direction: column;
            overflow: hidden;
            padding: 8px;
            margin-bottom: 5px; 
        }

        .container.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .top-section {
            flex-shrink: 0;
            margin-bottom: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .display-area {
            text-align: center;
            background: #fff;
            border-radius: 12px;
            border: 2px solid #eee;
            padding: 5px;
            height: 140px; 
            min-height: 140px;
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .big-symbol {
            font-size: 5rem;
            font-weight: 900;
            margin: 0;
            line-height: 1;
            flex-shrink: 0;
            width: 35%;
            text-align: center;
        }

        .examples {
            display: flex;
            flex-direction: column;
            gap: 4px;
            justify-content: center;
            flex-grow: 1;
            width: 65%;
        }

        .example-tag {
            background-color: #fff;
            border: 2px solid #e0e0e0;
            padding: 4px 0;
            border-radius: 10px;
            font-size: 1.15rem;
            color: #555;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            transition: all 0.1s;
            position: relative;
        }
        .example-tag:active { background-color: #f0f0f0; transform: scale(0.98); }

        ruby { display: inline-flex; flex-direction: column; align-items: center; margin: 0 1px; vertical-align: middle; line-height: 1.1; }
        rt { font-size: 0.7em; color: #777; margin-bottom: -2px; font-weight: normal; }
        
        .sound-icon-img { 
            width: 16px; 
            height: 16px; 
            margin-left: 6px; 
            opacity: 0.7; 
            vertical-align: middle;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f4f4f4;
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .score-board { 
            font-weight: bold; 
            color: #4A89A6; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .medal-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
            vertical-align: middle;
        }

        .grid-wrapper {
            flex: 1; 
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr); 
            grid-template-rows: repeat(7, 1fr); 
            gap: 4px; 
            padding: 2px;
            padding-bottom: 5px;
            flex: 1; 
            height: 100%; 
        }

        .symbol-grid.disabled {
            pointer-events: none;
            opacity: 0.4;
            filter: grayscale(0.5);
        }

        .symbol-btn {
            height: 100%; 
            width: 100%;
            border: none;
            border-radius: 8px;
            font-size: 1.4rem; 
            font-family: "Dela Gothic One", "Microsoft JhengHei", sans-serif; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
            padding: 0;
        }
        .symbol-btn:active { transform: scale(0.95); opacity: 0.8; }

        @keyframes raindrop-jump-slow {
            0% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        .jump-anim { animation: raindrop-jump-slow 0.8s ease-in-out; }

        .play-quiz-btn {
            background-color: var(--btn-color);
            color: white;
            font-size: 1.1rem;
            padding: 10px 0;
            width: 100%;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 3px 0 var(--btn-shadow);
            font-weight: bold;
            transition: all 0.2s;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .play-quiz-btn:active { transform: translateY(3px); box-shadow: none; }
        .play-quiz-btn.next-mode { 
            animation: pulse 1s infinite;
            z-index: 1001; 
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .feedback-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; 
            justify-content: center; 
            align-items: flex-start;
            z-index: 1000; 
            pointer-events: none; 
            opacity: 0;
            transition: opacity 0.3s;
            padding-top: 250px; 
        }
        .feedback-overlay.show { opacity: 1; pointer-events: auto; }

        .feedback-container {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 0 20px;
        }

        @keyframes celebration-pop {
            0% { transform: scale(0); opacity: 0;}
            50% { transform: scale(1.2); opacity: 1;}
            70% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .feedback-char {
            font-size: 7rem;
            font-weight: 900;
            color: white;
            width: 110px;
            height: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            text-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            font-family: "Dela Gothic One", "Microsoft JhengHei", sans-serif; 
            animation: celebration-pop 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            cursor: pointer;
            position: relative;
            z-index: 5;
        }
        .feedback-char:active { transform: scale(0.9); }

        .feedback-gif {
            width: 90px;
            height: auto;
            pointer-events: none;
            z-index: 10;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            margin-bottom: -15px;
            animation: slideDown 0.5s ease-out 0.2s both;
            position: relative;
        }
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .feedback-words-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 20px;
            animation: fadeIn 0.5s ease-out 0.5s both;
        }
        
        .feedback-word-tag {
            background-color: white;
            border: 3px solid #fff;
            padding: 6px 0;
            border-radius: 12px;
            font-size: 1.3rem;
            color: #444;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.2s;
            width: 100%;
            max-width: 260px;
        }
        .feedback-word-tag:active { transform: scale(0.95); background-color: #eee; }

        .feedback-wrong-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
            margin-top: 100px;
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; filter: brightness(0.7); }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .correct-pop { animation: pop 0.4s; filter: brightness(1.2); box-shadow: 0 0 10px gold; z-index: 100; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .particle { position: fixed; pointer-events: none; animation: fall 1s linear forwards; z-index: 1002; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

        /* ÊâãÊ©üÁâàÈù¢ÈÅ©ÈÖç */
        @media (max-width: 600px) {
            #learning-display {
                flex-direction: row;
                gap: 10px;
                padding: 5px;
                height: 160px; 
            }
            .feedback-overlay {
                padding-top: 250px; 
            }
        }

    </style>
</head>
<body>

    <header>
        <img src="https://cdn-icons-png.flaticon.com/128/458/458842.png" class="header-icon" alt="Rainbow">
        <h1>Ê≥®Èü≥Á¨¶ËôüÂ§ßÂÜíÈö™</h1>
        <img src="https://cdn-icons-png.flaticon.com/128/4509/4509748.png" class="header-icon" alt="Flower">
        
        <div class="voice-control" id="voice-status">ÂúãË™ûÊó•Â†±ÂéüÈü≥</div>
    </header>

    <div class="nav-container">
        <button class="nav-btn active" onclick="switchMode('learning')">
            <img src="https://cdn-icons-png.flaticon.com/128/10773/10773833.png" class="nav-icon-img" alt="Folder">
            Â≠∏ÁøíÂçÄ
        </button>
        <button class="nav-btn" onclick="switchMode('quiz')">
            <img src="https://cdn-icons-png.flaticon.com/128/13983/13983889.png" class="nav-icon-img" alt="Check">
            ÊåëÊà∞ÂçÄ
            <img src="https://cdn-icons-png.flaticon.com/128/9068/9068678.png" class="nav-icon-img" alt="Close">
        </button>
    </div>

    <div id="learning-section" class="container active">
        <div class="top-section">
            <div class="display-area" id="learning-display">
                <h3 style="color:#aaa; margin:0;">üëá ÈªûÊìä‰∏ãÊñπÊ≥®Èü≥</h3>
            </div>
        </div>
        <div class="grid-wrapper">
            <div class="symbol-grid" id="learning-grid"></div>
        </div>
    </div>

    <div id="quiz-section" class="container">
        <div class="top-section">
            <div class="quiz-header">
                <div class="score-board">
                    <img src="https://cdn-icons-png.flaticon.com/128/2659/2659850.png" class="medal-icon" alt="Medal">
                    ÈÄ£Á∫åÁ≠îÂ∞çÔºö<span id="score-val">0</span> È°å
                </div>
                <div id="quiz-status" style="color:#666;">Ê∫ñÂÇôÈñãÂßã</div>
            </div>
            <button id="quiz-control-btn" class="play-quiz-btn" onclick="handleQuizControl()">
                <img src="https://cdn-icons-png.flaticon.com/128/786/786474.png" class="nav-icon-img" id="quiz-speaker-icon"> 
                <span id="quiz-btn-text">Êí≠ÊîæÈ°åÁõÆËÅ≤Èü≥</span>
            </button>
        </div>
        <div class="grid-wrapper">
            <div class="symbol-grid disabled" id="quiz-grid"></div>
        </div>
    </div>

    <div id="feedback" class="feedback-overlay"></div>

<script>
    // --- 1. Ë≥áÊñôÂ∫´ ---
    const zhuyinData = [
        { char: "„ÑÖ", id: 1, examples: [{w:"Áà∏Áà∏", p:"„ÑÖ„ÑöÀã Àô„ÑÖ„Ñö"}, {w:"ÂåÖÂ≠ê", p:"„ÑÖ„Ñ† Àô„Ñó"}, {w:"È§Ö‰πæ", p:"„ÑÖ„Ñß„Ñ•Àá „Ñç„Ñ¢"}] },
        { char: "„ÑÜ", id: 2, examples: [{w:"ËòãÊûú", p:"„ÑÜ„Ñß„Ñ•Àä „Ñç„Ñ®„ÑõÀá"}, {w:"ÊúãÂèã", p:"„ÑÜ„Ñ•Àä „Ñß„Ñ°Àá"}, {w:"Ëë°ËêÑ", p:"„ÑÜ„Ñ®Àä „Ñä„Ñ†Àä"}] },
        { char: "„Ñá", id: 3, examples: [{w:"Â™ΩÂ™Ω", p:"„Ñá„Ñö Àô„Ñá„Ñö"}, {w:"È∫µÂåÖ", p:"„Ñá„Ñß„Ñ¢Àã „ÑÖ„Ñ†"}, {w:"Â∏ΩÂ≠ê", p:"„Ñá„Ñ†Àã Àô„Ñó"}] },
        { char: "„Ñà", id: 4, examples: [{w:"È£õÊ©ü", p:"„Ñà„Ñü „Ñê„Ñß"}, {w:"ËúúËúÇ", p:"„Ñá„ÑßÀã „Ñà„Ñ•"}, {w:"ÊàøÂ≠ê", p:"„Ñà„Ñ§Àä Àô„Ñó"}] },
        { char: "„Ñâ", id: 5, examples: [{w:"ÂºüÂºü", p:"„Ñâ„ÑßÀã Àô„Ñâ„Ñß"}, {w:"ËõãÁ≥ï", p:"„Ñâ„Ñ¢Àã „Ñç„Ñ†"}, {w:"Â§ßË±°", p:"„Ñâ„ÑöÀã „Ñí„Ñß„Ñ§Àã"}] },
        { char: "„Ñä", id: 6, examples: [{w:"ÂÖîÂ≠ê", p:"„Ñä„Ñ®Àã Àô„Ñó"}, {w:"Â§™ÈôΩ", p:"„Ñä„ÑûÀã „Ñß„Ñ§Àä"}, {w:"Á≥ñÊûú", p:"„Ñä„Ñ§Àä „Ñç„Ñ®„ÑõÀá"}] },
        { char: "„Ñã", id: 7, examples: [{w:"ÁâõÂ•∂", p:"„Ñã„Ñß„Ñ°Àä „Ñã„ÑûÀá"}, {w:"Â•∂Â•∂", p:"„Ñã„ÑûÀá Àô„Ñã„Ñû"}, {w:"Ê™∏Ê™¨", p:"„Ñã„Ñß„Ñ•Àä „Ñá„Ñ•Àä"}] },
        { char: "„Ñå", id: 8, examples: [{w:"ËÄÅËôé", p:"„Ñå„Ñ†Àá „Ñè„Ñ®Àá"}, {w:"Âø´Ê®Ç", p:"„Ñé„Ñ®„ÑûÀã „Ñå„ÑúÀã"}, {w:"Ê®ìÊ¢Ø", p:"„Ñå„Ñ°Àä „Ñä„Ñß"}] },
        { char: "„Ñç", id: 9, examples: [{w:"Âì•Âì•", p:"„Ñç„Ñú Àô„Ñç„Ñú"}, {w:"ËòãÊûú", p:"„ÑÜ„Ñß„Ñ•Àä „Ñç„Ñ®„ÑõÀá"}, {w:"ÁãóÁãó", p:"„Ñç„Ñ°Àá Àô„Ñç„Ñ°"}] },
        { char: "„Ñé", id: 10, examples: [{w:"ÊÅêÈæç", p:"„Ñé„Ñ®„Ñ•Àá „Ñå„Ñ®„Ñ•Àä"}, {w:"Âç°Áâá", p:"„Ñé„ÑöÀá „ÑÜ„Ñß„Ñ¢Àã"}, {w:"Ë§≤Â≠ê", p:"„Ñé„Ñ®Àã Àô„Ñó"}] },
        { char: "„Ñè", id: 11, examples: [{w:"Ëä±Êúµ", p:"„Ñè„Ñ®„Ñö „Ñâ„Ñ®„ÑõÀá"}, {w:"Áå¥Â≠ê", p:"„Ñè„Ñ°Àä Àô„Ñó"}, {w:"Ëù¥Ëù∂", p:"„Ñè„Ñ®Àä „Ñâ„Ñß„ÑùÀä"}] },
        { char: "„Ñê", id: 12, examples: [{w:"ÈõûËõã", p:"„Ñê„Ñß „Ñâ„Ñ¢Àã"}, {w:"Á©çÊú®", p:"„Ñê„Ñß „Ñá„Ñ®Àã"}, {w:"Ê©òÂ≠ê", p:"„Ñê„Ñ©Àä Àô„Ñó"}] },
        { char: "„Ñë", id: 13, examples: [{w:"Ê∞£ÁêÉ", p:"„Ñë„ÑßÀã „Ñë„Ñß„Ñ°Àä"}, {w:"‰ºÅÈµù", p:"„Ñë„ÑßÀã „ÑúÀä"}, {w:"Â∑ßÂÖãÂäõ", p:"„Ñë„Ñß„Ñ†Àá „Ñé„ÑúÀã „Ñå„ÑßÀã"}] },
        { char: "„Ñí", id: 14, examples: [{w:"Ë•øÁìú", p:"„Ñí„Ñß „Ñç„Ñ®„Ñö"}, {w:"ÊòüÊòü", p:"„Ñí„Ñß„Ñ• „Ñí„Ñß„Ñ•"}, {w:"È¶ôËïâ", p:"„Ñí„Ñß„Ñ§ „Ñê„Ñß„Ñ†"}] },
        { char: "„Ñì", id: 15, examples: [{w:"ËúòËõõ", p:"„Ñì „Ñì„Ñ®"}, {w:"Ê°åÂ≠ê", p:"„Ñì„Ñ®„Ñõ Àô„Ñó"}, {w:"Ë±¨ËÇâ", p:"„Ñì„Ñ® „Ññ„Ñ°Àã"}] },
        { char: "„Ñî", id: 16, examples: [{w:"ÂêÉÈ£Ø", p:"„Ñî „Ñà„Ñ¢Àã"}, {w:"ËªäÂ≠ê", p:"„Ñî„Ñú Àô„Ñó"}, {w:"Èï∑È†∏Èπø", p:"„Ñî„Ñ§Àä „Ñê„Ñß„Ñ•Àá „Ñå„Ñ®Àã"}] },
        { char: "„Ñï", id: 17, examples: [{w:"ÁçÖÂ≠ê", p:"„Ñï Àô„Ñó"}, {w:"Êõ∏Êú¨", p:"„Ñï„Ñ® „ÑÖ„Ñ£Àá"}, {w:"ÊâãÈå∂", p:"„Ñï„Ñ°Àá „ÑÖ„Ñß„Ñ†Àá"}] },
        { char: "„Ññ", id: 18, examples: [{w:"ÁÜ±Áãó", p:"„Ññ„ÑúÀã „Ñç„Ñ°Àá"}, {w:"Êó•Êúü", p:"„ÑñÀã „Ñë„ÑßÀä"}, {w:"‰π≥Áâõ", p:"„Ññ„Ñ®Àá „Ñã„Ñß„Ñ°Àä"}] },
        { char: "„Ñó", id: 19, examples: [{w:"Êó©ÂÆâ", p:"„Ñó„Ñ†Àá „Ñ¢"}, {w:"Ëµ∞Ë∑Ø", p:"„Ñó„Ñ°Àá „Ñå„Ñ®Àã"}, {w:"Á¥´Ëâ≤", p:"„ÑóÀá „Ñô„ÑúÀã"}] },
        { char: "„Ñò", id: 20, examples: [{w:"ËçâËéì", p:"„Ñò„Ñ†Àá „Ñá„ÑüÀä"}, {w:"ÂªÅÊâÄ", p:"„Ñò„ÑúÀã „Ñô„Ñ®„ÑõÀá"}, {w:"ÂΩ©Ëôπ", p:"„Ñò„ÑûÀá „Ñè„Ñ®„Ñ•Àä"}] },
        { char: "„Ñô", id: 21, examples: [{w:"ÊùæÈº†", p:"„Ñô„Ñ®„Ñ• „Ñï„Ñ®Àá"}, {w:"Ê£ÆÊûó", p:"„Ñô„Ñ£ „Ñå„Ñß„Ñ£Àä"}, {w:"‰∏âÊòéÊ≤ª", p:"„Ñô„Ñ¢ „Ñá„Ñß„Ñ•Àä „ÑìÀã"}] },
        // ‰ªãÈü≥
        { char: "„Ñß", id: 35, examples: [{w:"Ë°£Êúç", p:"„Ñß „Ñà„Ñ®Àä"}, {w:"Ê§ÖÂ≠ê", p:"„ÑßÀá Àô„Ñó"}, {w:"ÈÜ´Áîü", p:"„Ñß „Ñï„Ñ•"}] },
        { char: "„Ñ®", id: 36, examples: [{w:"ÁÉèÈæú", p:"„Ñ® „Ñç„Ñ®„Ñü"}, {w:"Â®ÉÂ®É", p:"„Ñ®„ÑöÀä Àô„Ñ®„Ñö"}, {w:"ÁÉèÈ¥â", p:"„Ñ® „Ñß„Ñö"}] },
        { char: "„Ñ©", id: 37, examples: [{w:"Èõ®ÂÇò", p:"„Ñ©Àá „Ñô„Ñ¢Àá"}, {w:"ÁéâÁ±≥", p:"„Ñ©Àã „Ñá„ÑßÀá"}, {w:"Êúà‰∫Æ", p:"„Ñ©„ÑùÀã „Ñå„Ñß„Ñ§Àã"}] },
        // ÈüªÊØç
        { char: "„Ñö", id: 22, examples: [{w:"È¥®Â≠ê", p:"„Ñß„Ñö Àô„Ñó"}, {w:"ÁâôÈΩí", p:"„Ñß„ÑöÀä „ÑîÀá"}, {w:"ÈòøÂß®", p:"„Ñö „ÑßÀä"}] },
        { char: "„Ñõ", id: 23, examples: [{w:"ËñÑËç∑", p:"„ÑÖ„ÑõÀã Àô„Ñè„Ñú"}, {w:"‰ΩõÁ•ñ", p:"„Ñà„ÑõÀä „Ñó„Ñ®Àá"}, {w:"ËÄÅÂ©Ü", p:"„Ñå„Ñ†Àá „ÑÜ„ÑõÀä"}] },
        { char: "„Ñú", id: 24, examples: [{w:"Â§©Èµù", p:"„Ñä„Ñß„Ñ¢ „ÑúÀä"}, {w:"ÂèØÊ®Ç", p:"„Ñé„ÑúÀá „Ñå„ÑúÀã"}, {w:"È±∑È≠ö", p:"„ÑúÀã „Ñ©Àä"}] },
        { char: "„Ñù", id: 25, examples: [{w:"Áà∫Áà∫", p:"„Ñß„ÑùÀä Àô„Ñß„Ñù"}, {w:"ËëâÂ≠ê", p:"„Ñß„ÑùÀã Àô„Ñó"}, {w:"ÈûãÂ≠ê", p:"„Ñí„Ñß„ÑùÀä Àô„Ñó"}] },
        { char: "„Ñû", id: 26, examples: [{w:"Â•∂Â•∂", p:"„Ñã„ÑûÀá Àô„Ñã„Ñû"}, {w:"Êµ∑Ë±ö", p:"„Ñè„ÑûÀá „Ñä„Ñ®„Ñ£Àä"}, {w:"ÁôΩËâ≤", p:"„ÑÖ„ÑûÀä „Ñô„ÑúÀã"}] },
        { char: "„Ñü", id: 27, examples: [{w:"Â¶πÂ¶π", p:"„Ñá„ÑüÀã Àô„Ñá„Ñü"}, {w:"ÊùØÂ≠ê", p:"„ÑÖ„Ñü Àô„Ñó"}, {w:"Ê£âË¢´", p:"„Ñá„Ñß„Ñ¢Àä „ÑÖ„ÑüÀã"}] },
        { char: "„Ñ†", id: 28, examples: [{w:"Â∞èË≤ì", p:"„Ñí„Ñß„Ñ†Àá „Ñá„Ñ†"}, {w:"ËçâËéì", p:"„Ñò„Ñ†Àá „Ñá„ÑüÀä"}, {w:"Ê°ÉÂ≠ê", p:"„Ñä„Ñ†Àä Àô„Ñó"}] },
        { char: "„Ñ°", id: 29, examples: [{w:"Áå¥Â≠ê", p:"„Ñè„Ñ°Àä Àô„Ñó"}, {w:"Â∞èÁãó", p:"„Ñí„Ñß„Ñ†Àá „Ñç„Ñ°Àá"}, {w:"ÊâãÂ•ó", p:"„Ñï„Ñ°Àá „Ñä„Ñ†Àã"}] },
        { char: "„Ñ¢", id: 30, examples: [{w:"ÈõûËõã", p:"„Ñê„Ñß „Ñâ„Ñ¢Àã"}, {w:"ÊôöÂÆâ", p:"„Ñ®„Ñ¢Àá „Ñ¢"}, {w:"È£ØÁ≥∞", p:"„Ñà„Ñ¢Àã „Ñä„Ñ®„Ñ¢Àä"}] },
        { char: "„Ñ£", id: 31, examples: [{w:"Â§ßÈñÄ", p:"„Ñâ„ÑöÀã „Ñá„Ñ£Àä"}, {w:"Ê£ÆÊûó", p:"„Ñô„Ñ£ „Ñå„Ñß„Ñ£Àä"}, {w:"ÊûïÈ†≠", p:"„Ñì„Ñ£Àá Àô„Ñä„Ñ°"}] },
        { char: "„Ñ§", id: 32, examples: [{w:"Á≥ñÊûú", p:"„Ñä„Ñ§Àä „Ñç„Ñ®„ÑõÀá"}, {w:"Â§™ÈôΩ", p:"„Ñä„ÑûÀã „Ñß„Ñ§Àä"}, {w:"Âπ´Âøô", p:"„ÑÖ„Ñ§ „Ñá„Ñ§Àä"}] },
        { char: "„Ñ•", id: 33, examples: [{w:"ËúúËúÇ", p:"„Ñá„ÑßÀã „Ñà„Ñ•"}, {w:"ÈõªÁáà", p:"„Ñâ„Ñß„Ñ¢Àã „Ñâ„Ñ•"}, {w:"È¢®ÁÆè", p:"„Ñà„Ñ• „Ñì„Ñ•"}] },
        { char: "„Ñ¶", id: 34, examples: [{w:"ËÄ≥Êúµ", p:"„Ñ¶Àá „Ñâ„Ñ®„Ñõ"}, {w:"ÂÖíÂ≠ê", p:"„Ñ¶Àä Àô„Ñó"}, {w:"ÂÖíÁ´•", p:"„Ñ¶Àä „Ñä„Ñ®„Ñ•Àä"}] }
    ];

    const colorPalette = ['#F06292', '#E57373', '#FFB74D', '#FFD54F', '#81C784', '#4DB6AC', '#64B5F6'];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const voiceStatus = document.getElementById('voice-status');
    
    const learningGrid = document.getElementById('learning-grid');
    const quizGrid = document.getElementById('quiz-grid');
    const learningDisplay = document.getElementById('learning-display');
    const feedbackOverlay = document.getElementById('feedback');
    const quizStatus = document.getElementById('quiz-status');
    const scoreVal = document.getElementById('score-val');
    const quizControlBtn = document.getElementById('quiz-control-btn');
    const quizBtnText = document.getElementById('quiz-btn-text');
    const quizSpeakerIcon = document.getElementById('quiz-speaker-icon');

    let currentScore = 0;
    let currentQuizAnswer = null;
    let isQuizActive = false;
    let wrongCount = 0;
    
    let isRainActive = false;
    let rainTimeouts = [];

    // --- Èü≥Êïà ---
    function playTone(freq, type, duration) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }
    
    function playSound(type) {
        if (type === 'click') playTone(800, 'triangle', 0.05);
        if (type === 'correct') { playTone(523, 'sine', 0.1); setTimeout(()=>playTone(659, 'sine', 0.3), 100); }
        if (type === 'wrong') { playTone(150, 'sawtooth', 0.15); setTimeout(()=>playTone(120, 'sawtooth', 0.3), 150); }
    }

    // --- Ê†∏ÂøÉË™ûÈü≥Êí≠Êîæ (ÊîØÊè¥ Callback) ---
    function playGoogleTTS(text, speed = 1.0, callback = null) {
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=zh-TW&q=${encodeURIComponent(text)}`;
        const audio = new Audio(url);
        audio.playbackRate = speed; 
        if (audio.preservesPitch !== undefined) audio.preservesPitch = true;
        
        if (callback) {
            audio.onended = callback;
        }

        audio.play().catch(e => {
            const synth = window.speechSynthesis;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "zh-TW";
            u.rate = speed; 
            if (callback) {
                u.onend = callback;
            }
            synth.speak(u);
        });
    }

    function playBpm(item) {
        const idStr = item.id.toString().padStart(2, '0');
        const mdnUrl = `https://www.mdnkids.com/BoPoMo/audio/${idStr}.mp3`;
        const audio = new Audio(mdnUrl);
        if (audio.preservesPitch !== undefined) audio.preservesPitch = true;
        audio.onplay = () => { voiceStatus.innerText = "ÂúãË™ûÊó•Â†±ÂéüÈü≥"; };
        audio.onerror = () => {
            voiceStatus.innerText = "Google Ë™ûÈü≥";
            playGoogleTTS(item.char, 1.0);
        };
        audio.play().catch(e => { playGoogleTTS(item.char, 1.0); });
    }

    // --- ÂàùÂßãÂåñÊåâÈàï ---
    zhuyinData.forEach((item, index) => {
        const bgColor = colorPalette[index % colorPalette.length];
        
        const btnL = createBtn(item, bgColor);
        btnL.onclick = () => { playSound('click'); showLearningDetail(item, bgColor); };
        learningGrid.appendChild(btnL);

        const btnQ = createBtn(item, bgColor);
        btnQ.onclick = () => checkAnswer(item, btnQ, bgColor);
        quizGrid.appendChild(btnQ);
    });

    function createBtn(item, color) {
        const btn = document.createElement('button');
        btn.className = 'symbol-btn';
        btn.innerText = item.char;
        btn.style.backgroundColor = color;
        return btn;
    }

    // --- Èõ®Êª¥ÂºèÂΩàË∑≥ ---
    function spawnRaindrop() {
        if (!isRainActive) return;
        const btns = document.querySelectorAll('#learning-grid .symbol-btn');
        if (btns.length === 0) return;
        const randIndex = Math.floor(Math.random() * btns.length);
        const btn = btns[randIndex];
        btn.classList.remove('jump-anim');
        void btn.offsetWidth; 
        btn.classList.add('jump-anim');
        const nextDelay = 1000 + Math.random() * 2500;
        const timeoutId = setTimeout(spawnRaindrop, nextDelay);
        rainTimeouts.push(timeoutId);
    }

    function startRainEffect() {
        if(isRainActive) return;
        isRainActive = true;
        for(let i=0; i<4; i++) {
            const timeoutId = setTimeout(spawnRaindrop, i * 600);
            rainTimeouts.push(timeoutId);
        }
    }

    function stopRainEffect() {
        isRainActive = false;
        rainTimeouts.forEach(id => clearTimeout(id));
        rainTimeouts = [];
        document.querySelectorAll('#learning-grid .symbol-btn').forEach(btn => {
            btn.classList.remove('jump-anim');
        });
    }

    // --- Â≠∏ÁøíÂçÄÈÇèËºØ ---
    function showLearningDetail(item, color) {
        const wordsHtml = item.examples.map(ex => {
            const chars = ex.w.split('');
            const bopomofos = ex.p.split(' ');
            let rubyHtml = '';
            chars.forEach((char, i) => {
                const bpm = bopomofos[i] || ''; 
                rubyHtml += `<ruby>${char}<rt>${bpm}</rt></ruby>`;
            });
            return `<div class="example-tag" style="border-color:${color};" onclick="playGoogleTTS('${ex.w}', 1.0); event.stopPropagation();">
                        ${rubyHtml} 
                        <img src="https://cdn-icons-png.flaticon.com/128/786/786474.png" class="sound-icon-img" alt="Sound">
                    </div>`;
        }).join('');

        learningDisplay.innerHTML = `
            <div class="big-symbol" style="color:${color}">${item.char}</div>
            <div class="examples">${wordsHtml}</div>
        `;
        playBpm(item);
    }

    // --- Ê∏¨È©óÂçÄÈÇèËºØ ---
    function switchMode(mode) {
        playSound('click');
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

        if(mode === 'learning') {
            document.getElementById('learning-section').classList.add('active');
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
            startRainEffect(); 
        } else {
            document.getElementById('quiz-section').classList.add('active');
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            stopRainEffect(); 
            resetQuizUI();
        }
    }
    
    startRainEffect();

    function handleQuizControl() {
        if (isQuizActive) {
            playBpm(currentQuizAnswer);
            quizControlBtn.style.transform = "scale(0.95)";
            setTimeout(() => quizControlBtn.style.transform = "scale(1)", 100);
        } else {
            feedbackOverlay.classList.remove('show');
            startNewQuestion();
        }
    }

    function startNewQuestion() {
        const randomIndex = Math.floor(Math.random() * zhuyinData.length);
        currentQuizAnswer = zhuyinData[randomIndex];
        isQuizActive = true;
        wrongCount = 0;
        
        quizStatus.innerText = "üëÇ Ë´ã‰ªîÁ¥∞ËÅΩÔºåÈÅ∏Âá∫Ê≠£Á¢∫ÁöÑÊ≥®Èü≥";
        quizStatus.style.color = "#4A89A6";
        quizBtnText.innerText = "ÈáçËÅΩ‰∏ÄÊ¨°";
        quizControlBtn.classList.remove('next-mode');
        
        quizGrid.classList.remove('disabled');

        document.querySelectorAll('#quiz-grid .symbol-btn').forEach(btn => {
            btn.classList.remove('shake', 'correct-pop');
            btn.style.opacity = "1";
        });
        
        playBpm(currentQuizAnswer);
    }
    
    function resetQuizUI() {
        isQuizActive = false;
        quizBtnText.innerText = "ÈñãÂßãÂá∫È°å";
        quizControlBtn.classList.remove('next-mode');
        quizStatus.innerText = "Êåâ‰∏ãÊåâÈàïÈñãÂßãÊåëÊà∞ÔºÅ";
        quizGrid.classList.add('disabled');
        feedbackOverlay.classList.remove('show');
    }

    function checkAnswer(selectedItem, btnElement, color) {
        if (!isQuizActive) return;

        if (selectedItem.char === currentQuizAnswer.char) {
            // Á≠îÂ∞ç
            playSound('correct');
            showFeedback('correct', selectedItem, color);
            btnElement.classList.add('correct-pop');
            fireConfetti();
            currentScore++;
            scoreVal.innerText = currentScore;
            quizStatus.innerText = "‚ú® Á≠îÂ∞ç‰∫ÜÔºÅÂ•ΩÊ£íÔºÅ";
            playGoogleTTS("Á≠îÂ∞ç‰∫Ü", 1.0);
            endRound(); 
        } else {
            // Á≠îÈåØ
            playSound('wrong');
            btnElement.classList.add('shake');
            setTimeout(() => btnElement.classList.remove('shake'), 500);
            
            wrongCount++;
            if (wrongCount >= 3) {
                // 3Ê¨°ÈåØ
                const correctIndex = zhuyinData.indexOf(currentQuizAnswer);
                const correctColor = colorPalette[correctIndex % colorPalette.length];
                showFeedback('reveal', currentQuizAnswer, correctColor);
                quizStatus.innerText = `Ê≠£Á¢∫Á≠îÊ°àÊòØÔºö${currentQuizAnswer.char}`;
                
                // V32: ‰∏≤Êé•Ë™ûÈü≥ (Á≠îÊ°àÊòØ... [ÂÅúÈ†ì]... „ÑÖ)
                playGoogleTTS("Ê≠£Á¢∫Á≠îÊ°àÊòØ", 1.0, () => {
                    setTimeout(() => playBpm(currentQuizAnswer), 300);
                });

                document.querySelectorAll('#quiz-grid .symbol-btn').forEach(b => {
                    if(b.innerText === currentQuizAnswer.char) b.classList.add('correct-pop');
                });
                currentScore = 0;
                scoreVal.innerText = 0;
                endRound();
            } else {
                quizStatus.innerText = "üí™ Âä†Ê≤πÔºåÂèØ‰ª•ÊåâÊåâÈàïÈáçËÅΩ‰∏ÄÊ¨°ÔºÅ";
                showFeedback('wrong');
            }
        }
    }

    function endRound() {
        isQuizActive = false;
        quizBtnText.innerText = "‰∏ã‰∏ÄÈ°å";
        quizControlBtn.classList.add('next-mode');
        quizGrid.classList.add('disabled');
    }

    function showFeedback(mode, item, color = "#4A89A6") {
        if (mode === 'correct' || mode === 'reveal') {
            const gifUrl = "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHRod2U4bHd4OXhsdG5zYnI4NDA5cGtmeG4xd2EwOG9lMmtmbTludyZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/D0jidt0aW8DD2YZkAB/giphy.gif";
            const gifHtml = (mode === 'correct') ? `<img src="${gifUrl}" class="feedback-gif" alt="Good Job!">` : '';
            
            const wordsHtml = item.examples.map(ex => {
                const chars = ex.w.split('');
                const bopomofos = ex.p.split(' ');
                let rubyHtml = '';
                chars.forEach((char, i) => {
                    const bpm = bopomofos[i] || ''; 
                    rubyHtml += `<ruby>${char}<rt>${bpm}</rt></ruby>`;
                });
                return `<div class="feedback-word-tag" style="border-color:${color};" onclick="playGoogleTTS('${ex.w}', 1.0); event.stopPropagation();">
                            ${rubyHtml} 
                            <img src="https://cdn-icons-png.flaticon.com/128/786/786474.png" class="sound-icon-img" alt="Sound">
                        </div>`;
            }).join('');

            const charClickAttr = `onclick="playBpm({id:${item.id}, char:'${item.char}'}); event.stopPropagation();"`;

            feedbackOverlay.innerHTML = `
                <div class="feedback-container">
                    ${gifHtml}
                    <div class="feedback-char" style="background-color: ${color}" ${charClickAttr}>
                        ${item.char}
                    </div>
                    <div class="feedback-words-area">
                        ${wordsHtml}
                    </div>
                </div>
            `;
            feedbackOverlay.classList.add('show');
        } else {
            // V30: ‰ΩøÁî®Á¥ÖËâ≤ÂèâÂèâÂúñÁâá
            feedbackOverlay.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/128/9068/9068678.png" class="feedback-wrong-img">`;
            feedbackOverlay.classList.add('show');
            setTimeout(() => feedbackOverlay.classList.remove('show'), 800);
        }
    }

    function fireConfetti() {
        const colors = colorPalette;
        for(let i=0; i<30; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            p.style.left = Math.random() * 100 + 'vw';
            p.style.top = '-10px';
            p.style.width = (Math.random() * 10 + 5) + 'px';
            p.style.height = (Math.random() * 10 + 5) + 'px';
            p.style.animationDuration = (Math.random() * 1 + 0.5) + 's';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1500);
        }
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³¨éŸ³ç¬¦è™Ÿå¤§å†’éšª</title>
    <style>
        :root {
            --bg: #FDF6E3;
            --text: #555;
            --correct: #6BCB77;
            --wrong: #FF6B6B;
            --primary-color: #4A89A6;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "Microsoft JhengHei", "Rounded Mplus 1c", sans-serif;
            background-color: var(--bg);
            background-image: linear-gradient(180deg, #E0F7FA 0%, #FFF3E0 100%);
            background-attachment: fixed;
            color: var(--text);
            margin: 0;
            padding: 10px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden; 
            user-select: none;
            position: relative;
        }

        /* --- æ¨™é¡Œå€å¡Š (å½©è™¹ + æ¨™é¡Œ + èŠ±æœµ) --- */
        header {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 10px;
            flex-shrink: 0;
            height: 40px;
            gap: 10px; /* åœ–ç¤ºèˆ‡æ–‡å­—é–“è· */
        }

        h1 {
            color: #4A89A6;
            font-size: 1.5rem;
            text-shadow: 2px 2px 0px #fff;
            margin: 0;
            font-weight: 900;
            white-space: nowrap;
        }

        .header-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
            filter: drop-shadow(1px 2px 2px rgba(0,0,0,0.1));
        }

        /* èªéŸ³æ¨™ç¤º (å³ä¸Šè§’å›ºå®š) */
        .voice-control {
            position: absolute;
            right: 0;
            top: -5px;
            font-size: 0.65rem;
            color: #666;
            background: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            z-index: 20;
        }

        /* å°èˆªåˆ— (V21 æ‰å¹³é¢¨æ ¼) */
        .nav-container {
            background: rgba(0, 0, 0, 0.08); /* æ·ºç°è»Œé“ */
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            width: 100%;
            max-width: 600px;
            flex-shrink: 0;
        }

        .nav-btn {
            flex: 1;
            padding: 8px 0;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: transparent;
            color: #666; 
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .nav-icon-img {
            width: 22px;
            height: 22px;
            object-fit: contain;
            vertical-align: middle;
        }

        /* é¸ä¸­ç‹€æ…‹ï¼šç™½è‰²å¡ç‰‡æµ®èµ· */
        .nav-btn.active {
            background-color: #fff;
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ä¸»å®¹å™¨ */
        .container {
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
            padding: 12px;
        }

        .container.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .top-section {
            flex-shrink: 0;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* é¡¯ç¤ºå€ */
        .display-area {
            text-align: center;
            background: #fff;
            border-radius: 16px;
            border: 2px solid #eee;
            padding: 10px;
            min-height: 180px; 
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .big-symbol {
            font-size: 6rem;
            font-weight: 900;
            margin: 0;
            line-height: 1;
            flex-shrink: 0;
            width: 40%;
            text-align: center;
            color: var(--primary-color);
        }

        .examples {
            display: flex;
            flex-direction: column;
            gap: 6px;
            justify-content: center;
            flex-grow: 1;
            width: 60%;
        }

        /* åè©å¡ç‰‡ (ç­‰å¯¬è¨­è¨ˆ) */
        .example-tag {
            background-color: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 6px 0;
            border-radius: 12px;
            font-size: 1.3rem;
            color: #555;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%; /* å¼·åˆ¶ç­‰å¯¬ */
            transition: all 0.1s;
            position: relative;
        }
        .example-tag:active { background-color: #e3f2fd; transform: scale(0.98); }

        ruby { 
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0 2px; 
            vertical-align: middle; 
            line-height: 1.1;
        }
        
        rt { 
            font-size: 0.8em; 
            color: #777; 
            margin-bottom: -2px; 
            font-weight: normal;
        }
        
        .sound-icon { font-size: 1rem; margin-left: 8px; opacity: 0.4; }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f4f4f4;
            padding: 8px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .score-board { font-weight: bold; color: #4A89A6; }

        .grid-wrapper {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* é è¨­ 5 åˆ— */
            gap: 6px;
            padding-bottom: 20px;
            transition: opacity 0.3s;
        }

        /* æ‰‹æ©Ÿç‰ˆæ”¹ 6 åˆ—ä»¥ç¯€çœç©ºé–“ */
        @media (max-width: 400px) {
            .symbol-grid { grid-template-columns: repeat(6, 1fr); }
        }

        .symbol-grid.disabled {
            pointer-events: none;
            opacity: 0.4;
            filter: grayscale(0.5);
        }

        .symbol-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 8px;
            font-size: 1.5rem;
            font-family: "Dela Gothic One", "Microsoft JhengHei", sans-serif; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
            position: relative;
        }
        .symbol-btn:active { transform: scale(0.95); }

        @keyframes raindrop-jump-slow {
            0% { transform: scale(1) translateY(0); }
            30% { transform: scale(1.1) translateY(-10px); }
            60% { transform: scale(0.95) translateY(2px); }
            100% { transform: scale(1) translateY(0); }
        }
        .jump-anim { animation: raindrop-jump-slow 1.2s ease-in-out; }

        /* ä¸‹ä¸€é¡ŒæŒ‰éˆ• */
        .play-quiz-btn {
            background-color: #4A89A6;
            color: white;
            font-size: 1.2rem;
            padding: 12px 0;
            width: 100%;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #366B84;
            font-weight: bold;
            transition: all 0.2s;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px; /* åœ–ç¤ºèˆ‡æ–‡å­—é–“è· */
        }
        .play-quiz-btn:active { transform: translateY(4px); box-shadow: none; }
        .play-quiz-btn.next-mode { 
            background-color: #E59372; 
            box-shadow: 0 4px 0 #c27658; 
            animation: pulse 1s infinite;
            z-index: 1001; 
        }
        
        .btn-icon-img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* --- ç­”é¡Œå›é¥‹é®ç½© (é˜²é®æ“‹ç‰ˆ) --- */
        .feedback-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; 
            justify-content: center; 
            align-items: flex-start; /* é ä¸Šå°é½Š */
            z-index: 1000; 
            pointer-events: none; 
            opacity: 0;
            transition: opacity 0.3s;
            /* é—œéµï¼šä½¿ç”¨ padding æ¨é–‹é ‚éƒ¨ï¼Œé¿é–‹æŒ‰éˆ• */
            padding-top: 250px; 
        }
        .feedback-overlay.show { opacity: 1; pointer-events: auto; }

        .feedback-container {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 0 20px;
        }

        @keyframes celebration-pop {
            0% { transform: scale(0); opacity: 0;}
            50% { transform: scale(1.2); opacity: 1;}
            70% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .feedback-char {
            font-size: 8rem;
            font-weight: 900;
            color: white;
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            text-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            font-family: "Dela Gothic One", "Microsoft JhengHei", sans-serif; 
            animation: celebration-pop 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            cursor: pointer;
            position: relative;
            z-index: 5;
        }
        .feedback-char:active { transform: scale(0.9); }

        .feedback-gif {
            width: 100px;
            height: auto;
            pointer-events: none;
            z-index: 10;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            margin-bottom: -20px;
            animation: slideDown 0.5s ease-out 0.2s both;
            position: relative;
        }
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .feedback-words-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 25px;
            animation: fadeIn 0.5s ease-out 0.5s both;
        }
        
        /* å›é¥‹å€çš„åè©å¡ç‰‡ï¼šç­‰å¯¬ */
        .feedback-word-tag {
            background-color: white;
            border: 3px solid #fff;
            padding: 8px 0;
            border-radius: 15px;
            font-size: 1.5rem;
            color: #444;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.2s;
            width: 100%;
            max-width: 280px;
        }
        .feedback-word-tag:active { transform: scale(0.95); background-color: #eee; }

        .feedback-wrong-text {
            font-size: 10rem;
            color: var(--wrong);
            text-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-weight: bold;
            margin-top: 100px;
        }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; filter: brightness(0.7); }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .correct-pop { animation: pop 0.4s; filter: brightness(1.2); box-shadow: 0 0 10px gold; z-index: 100; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .particle { position: fixed; pointer-events: none; animation: fall 1s linear forwards; z-index: 1002; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

        /* æ‰‹æ©Ÿç‰ˆé¢é©é… */
        @media (max-width: 600px) {
            #learning-display {
                flex-direction: row;
                gap: 10px;
                padding: 10px 5px;
            }
            .feedback-overlay {
                padding-top: 280px; /* æ‰‹æ©Ÿç‰ˆåŠ å¤§æ¨æ“  */
            }
        }

    </style>
</head>
<body>

    <header>
        <img src="https://cdn-icons-png.flaticon.com/128/458/458842.png" class="header-icon" alt="Rainbow">
        <h1>æ³¨éŸ³ç¬¦è™Ÿå¤§å†’éšª</h1>
        <img src="https://cdn-icons-png.flaticon.com/128/4509/4509748.png" class="header-icon" alt="Flower">
        
        <div class="voice-control" id="voice-status">ğŸ”Š åœ‹èªæ—¥å ±åŸéŸ³</div>
    </header>

    <div class="nav-container">
        <button class="nav-btn active" onclick="switchMode('learning')">
            <img src="https://cdn-icons-png.flaticon.com/128/10773/10773833.png" class="nav-icon-img" alt="Folder">
            å­¸ç¿’å€
        </button>
        <button class="nav-btn" onclick="switchMode('quiz')">
            <img src="https://cdn-icons-png.flaticon.com/128/13983/13983889.png" class="nav-icon-img" alt="Check">
            æŒ‘æˆ°å€
            <img src="https://cdn-icons-png.flaticon.com/128/9068/9068678.png" class="nav-icon-img" alt="Close">
        </button>
    </div>

    <div id="learning-section" class="container active">
        <div class="top-section">
            <div class="display-area" id="learning-display">
                <h3 style="color:#aaa; margin:0;">ğŸ‘‡ é»æ“Šä¸‹æ–¹æ³¨éŸ³</h3>
            </div>
        </div>
        <div class="grid-wrapper">
            <div class="symbol-grid" id="learning-grid"></div>
        </div>
    </div>

    <div id="quiz-section" class="container">
        <div class="top-section">
            <div class="quiz-header">
                <div class="score-board">ğŸ† é€£çºŒç­”å°ï¼š<span id="score-val">0</span> é¡Œ</div>
                <div id="quiz-status" style="color:#666;">æº–å‚™é–‹å§‹</div>
            </div>
            <button id="quiz-control-btn" class="play-quiz-btn" onclick="handleQuizControl()">
                <img src="https://cdn-icons-png.flaticon.com/128/3567/3567886.png" class="btn-icon-img" style="display:none;" id="next-icon"> 
                <span id="quiz-btn-text">ğŸ”Š æ’­æ”¾é¡Œç›®è²éŸ³</span>
            </button>
        </div>
        <div class="grid-wrapper">
            <div class="symbol-grid disabled" id="quiz-grid"></div>
        </div>
    </div>

    <div id="feedback" class="feedback-overlay"></div>

<script>
    // --- 1. è³‡æ–™åº« ---
    const zhuyinData = [
        { char: "ã„…", id: 1, examples: [{w:"çˆ¸çˆ¸", p:"ã„…ã„šË‹ Ë™ã„…ã„š"}, {w:"åŒ…å­", p:"ã„…ã„  Ë™ã„—"}, {w:"é¤…ä¹¾", p:"ã„…ã„§ã„¥Ë‡ ã„ã„¢"}] },
        { char: "ã„†", id: 2, examples: [{w:"è˜‹æœ", p:"ã„†ã„§ã„¥ËŠ ã„ã„¨ã„›Ë‡"}, {w:"æœ‹å‹", p:"ã„†ã„¥ËŠ ã„§ã„¡Ë‡"}, {w:"è‘¡è„", p:"ã„†ã„¨ËŠ ã„Šã„ ËŠ"}] },
        { char: "ã„‡", id: 3, examples: [{w:"åª½åª½", p:"ã„‡ã„š Ë™ã„‡ã„š"}, {w:"éºµåŒ…", p:"ã„‡ã„§ã„¢Ë‹ ã„…ã„ "}, {w:"å¸½å­", p:"ã„‡ã„ Ë‹ Ë™ã„—"}] },
        { char: "ã„ˆ", id: 4, examples: [{w:"é£›æ©Ÿ", p:"ã„ˆã„Ÿ ã„ã„§"}, {w:"èœœèœ‚", p:"ã„‡ã„§Ë‹ ã„ˆã„¥"}, {w:"æˆ¿å­", p:"ã„ˆã„¤ËŠ Ë™ã„—"}] },
        { char: "ã„‰", id: 5, examples: [{w:"å¼Ÿå¼Ÿ", p:"ã„‰ã„§Ë‹ Ë™ã„‰ã„§"}, {w:"è›‹ç³•", p:"ã„‰ã„¢Ë‹ ã„ã„ "}, {w:"å¤§è±¡", p:"ã„‰ã„šË‹ ã„’ã„§ã„¤Ë‹"}] },
        { char: "ã„Š", id: 6, examples: [{w:"å…”å­", p:"ã„Šã„¨Ë‹ Ë™ã„—"}, {w:"å¤ªé™½", p:"ã„Šã„Ë‹ ã„§ã„¤ËŠ"}, {w:"ç³–æœ", p:"ã„Šã„¤ËŠ ã„ã„¨ã„›Ë‡"}] },
        { char: "ã„‹", id: 7, examples: [{w:"ç‰›å¥¶", p:"ã„‹ã„§ã„¡ËŠ ã„‹ã„Ë‡"}, {w:"å¥¶å¥¶", p:"ã„‹ã„Ë‡ Ë™ã„‹ã„"}, {w:"æª¸æª¬", p:"ã„‹ã„§ã„¥ËŠ ã„‡ã„¥ËŠ"}] },
        { char: "ã„Œ", id: 8, examples: [{w:"è€è™", p:"ã„Œã„ Ë‡ ã„ã„¨Ë‡"}, {w:"å¿«æ¨‚", p:"ã„ã„¨ã„Ë‹ ã„Œã„œË‹"}, {w:"æ¨“æ¢¯", p:"ã„Œã„¡ËŠ ã„Šã„§"}] },
        { char: "ã„", id: 9, examples: [{w:"å“¥å“¥", p:"ã„ã„œ Ë™ã„ã„œ"}, {w:"è˜‹æœ", p:"ã„†ã„§ã„¥ËŠ ã„ã„¨ã„›Ë‡"}, {w:"ç‹—ç‹—", p:"ã„ã„¡Ë‡ Ë™ã„ã„¡"}] },
        { char: "ã„", id: 10, examples: [{w:"æé¾", p:"ã„ã„¨ã„¥Ë‡ ã„Œã„¨ã„¥ËŠ"}, {w:"å¡ç‰‡", p:"ã„ã„šË‡ ã„†ã„§ã„¢Ë‹"}, {w:"è¤²å­", p:"ã„ã„¨Ë‹ Ë™ã„—"}] },
        { char: "ã„", id: 11, examples: [{w:"èŠ±æœµ", p:"ã„ã„¨ã„š ã„‰ã„¨ã„›Ë‡"}, {w:"çŒ´å­", p:"ã„ã„¡ËŠ Ë™ã„—"}, {w:"è´è¶", p:"ã„ã„¨ËŠ ã„‰ã„§ã„ËŠ"}] },
        { char: "ã„", id: 12, examples: [{w:"é›è›‹", p:"ã„ã„§ ã„‰ã„¢Ë‹"}, {w:"ç©æœ¨", p:"ã„ã„§ ã„‡ã„¨Ë‹"}, {w:"æ©˜å­", p:"ã„ã„©ËŠ Ë™ã„—"}] },
        { char: "ã„‘", id: 13, examples: [{w:"æ°£çƒ", p:"ã„‘ã„§Ë‹ ã„‘ã„§ã„¡ËŠ"}, {w:"ä¼éµ", p:"ã„‘ã„§Ë‹ ã„œËŠ"}, {w:"å·§å…‹åŠ›", p:"ã„‘ã„§ã„ Ë‡ ã„ã„œË‹ ã„Œã„§Ë‹"}] },
        { char: "ã„’", id: 14, examples: [{w:"è¥¿ç“œ", p:"ã„’ã„§ ã„ã„¨ã„š"}, {w:"æ˜Ÿæ˜Ÿ", p:"ã„’ã„§ã„¥ ã„’ã„§ã„¥"}, {w:"é¦™è•‰", p:"ã„’ã„§ã„¤ ã„ã„§ã„ "}] },
        { char: "ã„“", id: 15, examples: [{w:"èœ˜è››", p:"ã„“ ã„“ã„¨"}, {w:"æ¡Œå­", p:"ã„“ã„¨ã„› Ë™ã„—"}, {w:"è±¬è‚‰", p:"ã„“ã„¨ ã„–ã„¡Ë‹"}] },
        { char: "ã„”", id: 16, examples: [{w:"åƒé£¯", p:"ã„” ã„ˆã„¢Ë‹"}, {w:"è»Šå­", p:"ã„”ã„œ Ë™ã„—"}, {w:"é•·é ¸é¹¿", p:"ã„”ã„¤ËŠ ã„ã„§ã„¥Ë‡ ã„Œã„¨Ë‹"}] },
        { char: "ã„•", id: 17, examples: [{w:"ç…å­", p:"ã„• Ë™ã„—"}, {w:"æ›¸æœ¬", p:"ã„•ã„¨ ã„…ã„£Ë‡"}, {w:"æ‰‹éŒ¶", p:"ã„•ã„¡Ë‡ ã„…ã„§ã„ Ë‡"}] },
        { char: "ã„–", id: 18, examples: [{w:"ç†±ç‹—", p:"ã„–ã„œË‹ ã„ã„¡Ë‡"}, {w:"æ—¥æœŸ", p:"ã„–Ë‹ ã„‘ã„§ËŠ"}, {w:"ä¹³ç‰›", p:"ã„–ã„¨Ë‡ ã„‹ã„§ã„¡ËŠ"}] },
        { char: "ã„—", id: 19, examples: [{w:"æ—©å®‰", p:"ã„—ã„ Ë‡ ã„¢"}, {w:"èµ°è·¯", p:"ã„—ã„¡Ë‡ ã„Œã„¨Ë‹"}, {w:"ç´«è‰²", p:"ã„—Ë‡ ã„™ã„œË‹"}] },
        { char: "ã„˜", id: 20, examples: [{w:"è‰è“", p:"ã„˜ã„ Ë‡ ã„‡ã„ŸËŠ"}, {w:"å»æ‰€", p:"ã„˜ã„œË‹ ã„™ã„¨ã„›Ë‡"}, {w:"å½©è™¹", p:"ã„˜ã„Ë‡ ã„ã„¨ã„¥ËŠ"}] },
        { char: "ã„™", id: 21, examples: [{w:"æ¾é¼ ", p:"ã„™ã„¨ã„¥ ã„•ã„¨Ë‡"}, {w:"æ£®æ—", p:"ã„™ã„£ ã„Œã„§ã„£ËŠ"}, {w:"ä¸‰æ˜æ²»", p:"ã„™ã„¢ ã„‡ã„§ã„¥ËŠ ã„“Ë‹"}] },
        // ä»‹éŸ³
        { char: "ã„§", id: 35, examples: [{w:"è¡£æœ", p:"ã„§ ã„ˆã„¨ËŠ"}, {w:"æ¤…å­", p:"ã„§Ë‡ Ë™ã„—"}, {w:"é†«ç”Ÿ", p:"ã„§ ã„•ã„¥"}] },
        { char: "ã„¨", id: 36, examples: [{w:"çƒé¾œ", p:"ã„¨ ã„ã„¨ã„Ÿ"}, {w:"å¨ƒå¨ƒ", p:"ã„¨ã„šËŠ Ë™ã„¨ã„š"}, {w:"çƒé´‰", p:"ã„¨ ã„§ã„š"}] },
        { char: "ã„©", id: 37, examples: [{w:"é›¨å‚˜", p:"ã„©Ë‡ ã„™ã„¢Ë‡"}, {w:"ç‰ç±³", p:"ã„©Ë‹ ã„‡ã„§Ë‡"}, {w:"æœˆäº®", p:"ã„©ã„Ë‹ ã„Œã„§ã„¤Ë‹"}] },
        // éŸ»æ¯
        { char: "ã„š", id: 22, examples: [{w:"é´¨å­", p:"ã„§ã„š Ë™ã„—"}, {w:"ç‰™é½’", p:"ã„§ã„šËŠ ã„”Ë‡"}, {w:"é˜¿å§¨", p:"ã„š ã„§ËŠ"}] },
        { char: "ã„›", id: 23, examples: [{w:"è–„è·", p:"ã„…ã„›Ë‹ Ë™ã„ã„œ"}, {w:"ä½›ç¥–", p:"ã„ˆã„›ËŠ ã„—ã„¨Ë‡"}, {w:"è€å©†", p:"ã„Œã„ Ë‡ ã„†ã„›ËŠ"}] },
        { char: "ã„œ", id: 24, examples: [{w:"å¤©éµ", p:"ã„Šã„§ã„¢ ã„œËŠ"}, {w:"å¯æ¨‚", p:"ã„ã„œË‡ ã„Œã„œË‹"}, {w:"é±·é­š", p:"ã„œË‹ ã„©ËŠ"}] },
        { char: "ã„", id: 25, examples: [{w:"çˆºçˆº", p:"ã„§ã„ËŠ Ë™ã„§ã„"}, {w:"è‘‰å­", p:"ã„§ã„Ë‹ Ë™ã„—"}, {w:"é‹å­", p:"ã„’ã„§ã„ËŠ Ë™ã„—"}] },
        { char: "ã„", id: 26, examples: [{w:"å¥¶å¥¶", p:"ã„‹ã„Ë‡ Ë™ã„‹ã„"}, {w:"æµ·è±š", p:"ã„ã„Ë‡ ã„Šã„¨ã„£ËŠ"}, {w:"ç™½è‰²", p:"ã„…ã„ËŠ ã„™ã„œË‹"}] },
        { char: "ã„Ÿ", id: 27, examples: [{w:"å¦¹å¦¹", p:"ã„‡ã„ŸË‹ Ë™ã„‡ã„Ÿ"}, {w:"æ¯å­", p:"ã„…ã„Ÿ Ë™ã„—"}, {w:"æ£‰è¢«", p:"ã„‡ã„§ã„¢ËŠ ã„…ã„ŸË‹"}] },
        { char: "ã„ ", id: 28, examples: [{w:"å°è²“", p:"ã„’ã„§ã„ Ë‡ ã„‡ã„ "}, {w:"è‰è“", p:"ã„˜ã„ Ë‡ ã„‡ã„ŸËŠ"}, {w:"æ¡ƒå­", p:"ã„Šã„ ËŠ Ë™ã„—"}] },
        { char: "ã„¡", id: 29, examples: [{w:"çŒ´å­", p:"ã„ã„¡ËŠ Ë™ã„—"}, {w:"å°ç‹—", p:"ã„’ã„§ã„ Ë‡ ã„ã„¡Ë‡"}, {w:"æ‰‹å¥—", p:"ã„•ã„¡Ë‡ ã„Šã„ Ë‹"}] },
        { char: "ã„¢", id: 30, examples: [{w:"é›è›‹", p:"ã„ã„§ ã„‰ã„¢Ë‹"}, {w:"æ™šå®‰", p:"ã„¨ã„¢Ë‡ ã„¢"}, {w:"é£¯ç³°", p:"ã„ˆã„¢Ë‹ ã„Šã„¨ã„¢ËŠ"}] },
        { char: "ã„£", id: 31, examples: [{w:"å¤§é–€", p:"ã„‰ã„šË‹ ã„‡ã„£ËŠ"}, {w:"æ£®æ—", p:"ã„™ã„£ ã„Œã„§ã„£ËŠ"}, {w:"æ•é ­", p:"ã„“ã„£Ë‡ Ë™ã„Šã„¡"}] },
        { char: "ã„¤", id: 32, examples: [{w:"ç³–æœ", p:"ã„Šã„¤ËŠ ã„ã„¨ã„›Ë‡"}, {w:"å¤ªé™½", p:"ã„Šã„Ë‹ ã„§ã„¤ËŠ"}, {w:"å¹«å¿™", p:"ã„…ã„¤ ã„‡ã„¤ËŠ"}] },
        { char: "ã„¥", id: 33, examples: [{w:"èœœèœ‚", p:"ã„‡ã„§Ë‹ ã„ˆã„¥"}, {w:"é›»ç‡ˆ", p:"ã„‰ã„§ã„¢Ë‹ ã„‰ã„¥"}, {w:"é¢¨ç®", p:"ã„ˆã„¥ ã„“ã„¥"}] },
        { char: "ã„¦", id: 34, examples: [{w:"è€³æœµ", p:"ã„¦Ë‡ ã„‰ã„¨ã„›"}, {w:"å…’å­", p:"ã„¦ËŠ Ë™ã„—"}, {w:"å…’ç«¥", p:"ã„¦ËŠ ã„Šã„¨ã„¥ËŠ"}] }
    ];

    // V27: èŠ±æœµè‰²ç³» (7è‰²å¾ªç’°)
    const colorPalette = [
        '#F06292', // èŠ±ç“£ç²‰
        '#81C784', // è‘‰å­ç¶ 
        '#FFB74D', // æ©˜é»ƒ
        '#4DB6AC', // æ·±é’
        '#E57373', // æ·±ç²‰ç´…
        '#AED581', // å«©ç¶ 
        '#FFD54F'  // äº®é»ƒ
    ];

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const voiceStatus = document.getElementById('voice-status');
    
    const learningGrid = document.getElementById('learning-grid');
    const quizGrid = document.getElementById('quiz-grid');
    const learningDisplay = document.getElementById('learning-display');
    const feedbackOverlay = document.getElementById('feedback');
    const quizStatus = document.getElementById('quiz-status');
    const scoreVal = document.getElementById('score-val');
    const quizControlBtn = document.getElementById('quiz-control-btn');
    const nextIcon = document.getElementById('next-icon');
    const quizBtnText = document.getElementById('quiz-btn-text');

    let currentScore = 0;
    let currentQuizAnswer = null;
    let isQuizActive = false;
    let wrongCount = 0;
    
    let isRainActive = false;
    let rainTimeouts = [];

    // --- éŸ³æ•ˆ ---
    function playTone(freq, type, duration) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }
    
    function playSound(type) {
        if (type === 'click') playTone(800, 'triangle', 0.05);
        if (type === 'correct') { playTone(523, 'sine', 0.1); setTimeout(()=>playTone(659, 'sine', 0.3), 100); }
        if (type === 'wrong') { playTone(150, 'sawtooth', 0.15); setTimeout(()=>playTone(120, 'sawtooth', 0.3), 150); }
    }

    // --- æ ¸å¿ƒèªéŸ³æ’­æ”¾ ---
    function playBpm(item) {
        const idStr = item.id.toString().padStart(2, '0');
        const mdnUrl = `https://www.mdnkids.com/BoPoMo/audio/${idStr}.mp3`;
        
        const audio = new Audio(mdnUrl);
        audio.playbackRate = 1.0; 
        if (audio.preservesPitch !== undefined) audio.preservesPitch = true;

        audio.onplay = () => { voiceStatus.innerText = "ğŸ”Š åœ‹èªæ—¥å ±åŸéŸ³"; };
        audio.onerror = () => {
            console.log("MDN è¼‰å…¥å¤±æ•—ï¼Œåˆ‡æ› Google TTS");
            voiceStatus.innerText = "ğŸ”Š Google æ™ºæ…§ç™¼éŸ³";
            playGoogleTTS(item.char, 1.0);
        };
        audio.play().catch(e => { playGoogleTTS(item.char, 1.0); });
    }

    function playGoogleTTS(text, speed = 1.0) {
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=zh-TW&q=${encodeURIComponent(text)}`;
        const audio = new Audio(url);
        audio.playbackRate = speed; 
        if (audio.preservesPitch !== undefined) audio.preservesPitch = true;
        audio.play().catch(e => {
            const synth = window.speechSynthesis;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "zh-TW";
            u.rate = speed; 
            synth.speak(u);
        });
    }

    // --- åˆå§‹åŒ–æŒ‰éˆ• ---
    zhuyinData.forEach((item, index) => {
        const bgColor = colorPalette[index % colorPalette.length];
        
        const btnL = createBtn(item, bgColor);
        btnL.onclick = () => { playSound('click'); showLearningDetail(item, bgColor); };
        learningGrid.appendChild(btnL);

        const btnQ = createBtn(item, bgColor);
        btnQ.onclick = () => checkAnswer(item, btnQ, bgColor);
        quizGrid.appendChild(btnQ);
    });

    function createBtn(item, color) {
        const btn = document.createElement('button');
        btn.className = 'symbol-btn';
        btn.innerText = item.char;
        btn.style.backgroundColor = color;
        return btn;
    }

    // --- é›¨æ»´å¼å½ˆè·³ (æ…¢é€Ÿç‰ˆ) ---
    function spawnRaindrop() {
        if (!isRainActive) return;
        const btns = document.querySelectorAll('#learning-grid .symbol-btn');
        if (btns.length === 0) return;
        const randIndex = Math.floor(Math.random() * btns.length);
        const btn = btns[randIndex];
        btn.classList.remove('jump-anim');
        void btn.offsetWidth; 
        btn.classList.add('jump-anim');
        
        const nextDelay = 1000 + Math.random() * 2500;
        const timeoutId = setTimeout(spawnRaindrop, nextDelay);
        rainTimeouts.push(timeoutId);
    }

    function startRainEffect() {
        if(isRainActive) return;
        isRainActive = true;
        for(let i=0; i<4; i++) {
            const timeoutId = setTimeout(spawnRaindrop, i * 600);
            rainTimeouts.push(timeoutId);
        }
    }

    function stopRainEffect() {
        isRainActive = false;
        rainTimeouts.forEach(id => clearTimeout(id));
        rainTimeouts = [];
        document.querySelectorAll('#learning-grid .symbol-btn').forEach(btn => {
            btn.classList.remove('jump-anim');
        });
    }

    // --- å­¸ç¿’å€é‚è¼¯ ---
    function showLearningDetail(item, color) {
        const wordsHtml = item.examples.map(ex => {
            const chars = ex.w.split('');
            const bopomofos = ex.p.split(' ');
            let rubyHtml = '';
            chars.forEach((char, i) => {
                const bpm = bopomofos[i] || ''; 
                rubyHtml += `<ruby>${char}<rt>${bpm}</rt></ruby>`;
            });
            return `<div class="example-tag" onclick="playGoogleTTS('${ex.w}', 1.0); event.stopPropagation();">
                        ${rubyHtml} <span class="sound-icon">ğŸ”Š</span>
                    </div>`;
        }).join('');

        learningDisplay.innerHTML = `
            <div class="big-symbol" style="color:${color}">${item.char}</div>
            <div class="examples">${wordsHtml}</div>
        `;
        playBpm(item);
    }

    // --- æ¸¬é©—å€é‚è¼¯ ---
    function switchMode(mode) {
        playSound('click');
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

        if(mode === 'learning') {
            document.getElementById('learning-section').classList.add('active');
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
            startRainEffect(); 
        } else {
            document.getElementById('quiz-section').classList.add('active');
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            stopRainEffect(); 
            resetQuizUI();
        }
    }
    
    startRainEffect();

    function handleQuizControl() {
        if (isQuizActive) {
            playBpm(currentQuizAnswer);
            quizControlBtn.style.transform = "scale(0.95)";
            setTimeout(() => quizControlBtn.style.transform = "scale(1)", 100);
        } else {
            feedbackOverlay.classList.remove('show');
            startNewQuestion();
        }
    }

    function startNewQuestion() {
        const randomIndex = Math.floor(Math.random() * zhuyinData.length);
        currentQuizAnswer = zhuyinData[randomIndex];
        isQuizActive = true;
        wrongCount = 0;
        
        quizStatus.innerText = "ğŸ‘‚ è«‹ä»”ç´°è½ï¼Œé¸å‡ºæ­£ç¢ºçš„æ³¨éŸ³";
        quizStatus.style.color = "#4A89A6";
        
        // è®Šå›ã€Œé‡è½ã€ç‹€æ…‹
        quizBtnText.innerText = "ğŸ”Š é‡è½ä¸€æ¬¡";
        nextIcon.style.display = "none";
        quizControlBtn.classList.remove('next-mode');
        
        quizGrid.classList.remove('disabled');

        document.querySelectorAll('#quiz-grid .symbol-btn').forEach(btn => {
            btn.classList.remove('shake', 'correct-pop');
            btn.style.opacity = "1";
        });
        
        playBpm(currentQuizAnswer);
    }
    
    function resetQuizUI() {
        isQuizActive = false;
        quizBtnText.innerText = "ğŸ”Š é–‹å§‹å‡ºé¡Œ";
        nextIcon.style.display = "none";
        quizControlBtn.classList.remove('next-mode');
        quizStatus.innerText = "æŒ‰ä¸‹æŒ‰éˆ•é–‹å§‹æŒ‘æˆ°ï¼";
        quizGrid.classList.add('disabled');
        feedbackOverlay.classList.remove('show');
    }

    function checkAnswer(selectedItem, btnElement, color) {
        if (!isQuizActive) return;

        if (selectedItem.char === currentQuizAnswer.char) {
            // ç­”å°
            playSound('correct');
            showFeedback('correct', selectedItem, color);
            
            btnElement.classList.add('correct-pop');
            fireConfetti();
            
            currentScore++;
            scoreVal.innerText = currentScore;
            
            quizStatus.innerText = "âœ¨ ç­”å°äº†ï¼å¥½æ£’ï¼";
            playGoogleTTS("ç­”å°äº†", 1.0);
            
            endRound(); 
        } else {
            // ç­”éŒ¯
            playSound('wrong');
            btnElement.classList.add('shake');
            setTimeout(() => btnElement.classList.remove('shake'), 500);
            
            wrongCount++;
            if (wrongCount >= 3) {
                // 3æ¬¡éŒ¯ -> æ­æ›‰
                const correctIndex = zhuyinData.indexOf(currentQuizAnswer);
                const correctColor = colorPalette[correctIndex % colorPalette.length];

                showFeedback('reveal', currentQuizAnswer, correctColor);
                
                quizStatus.innerText = `æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${currentQuizAnswer.char}`;
                playGoogleTTS(`æ­£ç¢ºç­”æ¡ˆæ˜¯${currentQuizAnswer.char}`, 1.0);
                
                document.querySelectorAll('#quiz-grid .symbol-btn').forEach(b => {
                    if(b.innerText === currentQuizAnswer.char) b.classList.add('correct-pop');
                });
                
                currentScore = 0;
                scoreVal.innerText = 0;
                endRound();
            } else {
                quizStatus.innerText = "ğŸ’ª åŠ æ²¹ï¼Œå¯ä»¥æŒ‰æŒ‰éˆ•é‡è½ä¸€æ¬¡ï¼";
                showFeedback('wrong');
            }
        }
    }

    function endRound() {
        isQuizActive = false;
        // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•èˆ‡ Icon
        quizBtnText.innerText = "ä¸‹ä¸€é¡Œ";
        nextIcon.style.display = "inline";
        quizControlBtn.classList.add('next-mode');
        quizGrid.classList.add('disabled');
    }

    function showFeedback(mode, item, color = "#4A89A6") {
        if (mode === 'correct' || mode === 'reveal') {
            const gifUrl = "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHRod2U4bHd4OXhsdG5zYnI4NDA5cGtmeG4xd2EwOG9lMmtmbTludyZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/D0jidt0aW8DD2YZkAB/giphy.gif";
            const gifHtml = (mode === 'correct') ? `<img src="${gifUrl}" class="feedback-gif" alt="Good Job!">` : '';
            
            const wordsHtml = item.examples.map(ex => {
                const chars = ex.w.split('');
                const bopomofos = ex.p.split(' ');
                let rubyHtml = '';
                chars.forEach((char, i) => {
                    const bpm = bopomofos[i] || ''; 
                    rubyHtml += `<ruby>${char}<rt>${bpm}</rt></ruby>`;
                });
                return `<div class="feedback-word-tag" onclick="playGoogleTTS('${ex.w}', 1.0); event.stopPropagation();">
                            ${rubyHtml} <span class="sound-icon">ğŸ”Š</span>
                        </div>`;
            }).join('');

            const charClickAttr = `onclick="playBpm({id:${item.id}, char:'${item.char}'}); event.stopPropagation();"`;

            feedbackOverlay.innerHTML = `
                <div class="feedback-container">
                    ${gifHtml}
                    <div class="feedback-char" style="background-color: ${color}" ${charClickAttr}>
                        ${item.char}
                    </div>
                    <div class="feedback-words-area">
                        ${wordsHtml}
                    </div>
                </div>
            `;
            feedbackOverlay.classList.add('show');
        } else {
            feedbackOverlay.innerHTML = `<div class="feedback-wrong-text">âŒ</div>`;
            feedbackOverlay.classList.add('show');
            setTimeout(() => feedbackOverlay.classList.remove('show'), 800);
        }
    }

    function fireConfetti() {
        const colors = colorPalette;
        for(let i=0; i<30; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            p.style.left = Math.random() * 100 + 'vw';
            p.style.top = '-10px';
            p.style.width = (Math.random() * 10 + 5) + 'px';
            p.style.height = (Math.random() * 10 + 5) + 'px';
            p.style.animationDuration = (Math.random() * 1 + 0.5) + 's';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1500);
        }
    }
</script>

</body>
</html>
